// Базовый абстрактный класс для построителей параграфов
//
// Роль в проекте:
// Предоставляет общую реализацию паттерна Builder для создания параграфов.
// Содержит всю общую логику накопления данных (заголовок, содержимое, футер),
// оставляя конкретным наследникам только финальную сборку объекта в методе Build().
//
// Применяемый паттерн:
// Builder (Строитель) + Template Method (Шаблонный метод)
//
// Почему абстрактный класс, а не интерфейс:
// Абстрактный класс позволяет предоставить реализацию по умолчанию для большей части
// методов Builder, избегая дублирования кода в наследниках. Наследники отличаются только
// способом создания финального объекта (DefaultParagraph или StyledParagraph).
//
// Реализация двух интерфейсов:
// Класс одновременно реализует IParagraphTitleSelector и IParagraphBuilder.
// Это позволяет использовать один и тот же объект на разных этапах построения,
// при этом обеспечивая типобезопасность через изменение возвращаемого типа методов.
//
// Модификатор доступа internal:
// Внешний код не должен иметь доступ к конкретным реализациям построителей.
// Создание происходит только через фабрики (IParagraphBuilderFactory).
//
// Связь с другими компонентами:
// - Является базой для DefaultParagraphBuilder и StyledParagraphBuilder
// - Реализует интерфейсы IParagraphTitleSelector и IParagraphBuilder
// - Создается через фабрики (DefaultParagraphBuilderFactory, StyledParagraphBuilderFactory)
namespace Workshop3.Paragraphs.Builders;

internal abstract class ParagraphBuilderBase :
    IParagraphTitleSelector,
    IParagraphBuilder
{
    // Список элементов содержимого параграфа
    //
    // Использует collection expression syntax ([]) из C# 12 для инициализации.
    // Список изменяемый, чтобы можно было добавлять элементы через AddContent().
    // Само поле readonly - нельзя заменить список, но можно изменять его содержимое.
    private readonly List<IRenderable> _content = [];

    // Заголовок параграфа (обязательный элемент)
    //
    // protected доступ позволяет наследникам получить заголовок в методе Build().
    // private set гарантирует, что заголовок может быть установлен только через WithTitle().
    // Nullable тип отражает, что заголовок может еще не быть установлен в процессе построения.
    protected IRenderable? Title { get; private set; }

    // Содержимое параграфа в виде read-only коллекции
    //
    // Возвращает IEnumerable для инкапсуляции - наследники могут перебирать элементы,
    // но не могут изменять коллекцию напрямую (только через AddContent()).
    // Это защищает внутреннее состояние от непредвиденных изменений.
    protected IEnumerable<IRenderable> Content => _content;

    // Футер параграфа (необязательный элемент)
    //
    // Аналогично Title, но nullable и остается таковым, если футер не установлен.
    // protected доступ для использования в наследниках при построении.
    protected IRenderable? Footer { get; private set; }

    // Устанавливает заголовок параграфа
    //
    // Параметры:
    //   title - объект для использования в качестве заголовка
    //
    // Возвращает: IParagraphBuilder (себя) для продолжения построения
    //
    // Это метод из интерфейса IParagraphTitleSelector. После его вызова builder
    // "переходит" в состояние IParagraphBuilder (хотя физически это тот же объект).
    // Возврат себя (return this) реализует fluent interface для цепочки вызовов.
    public IParagraphBuilder WithTitle(IRenderable title)
    {
        Title = title;
        return this;
    }

    // Добавляет элемент содержимого в параграф
    //
    // Параметры:
    //   content - элемент для добавления в тело параграфа
    //
    // Возвращает: себя для поддержки цепочки вызовов
    //
    // Метод аккумулирует содержимое - каждый вызов добавляет новый элемент в список.
    // Порядок вызовов важен, так как элементы будут отображаться в порядке добавления.
    public IParagraphBuilder AddContent(IRenderable content)
    {
        _content.Add(content);
        return this;
    }

    // Устанавливает футер параграфа
    //
    // Параметры:
    //   footer - объект для использования в качестве футера
    //
    // Возвращает: себя для поддержки цепочки вызовов
    //
    // Футер необязателен - если не вызвать этот метод, параграф будет без футера.
    // Если вызвать несколько раз, сохранится только последнее значение.
    public IParagraphBuilder WithFooter(IRenderable footer)
    {
        Footer = footer;
        return this;
    }

    // Абстрактный метод для финального создания объекта параграфа
    //
    // Возвращает: готовый объект IParagraph
    //
    // Паттерн Template Method:
    // Базовый класс определяет структуру (накопление данных через WithTitle, AddContent, WithFooter),
    // а конкретные наследники определяют финальную сборку (создание DefaultParagraph или StyledParagraph).
    //
    // Каждый наследник должен:
    // 1. Проверить наличие обязательных полей (Title не должен быть null)
    // 2. Создать соответствующий объект параграфа с накопленными данными
    // 3. Вернуть готовый объект
    public abstract IParagraph Build();
}
