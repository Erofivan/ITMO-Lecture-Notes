// Файл определяет результат вычисления выражения.
// Вычисление может быть полным (все переменные известны) или частичным
// (некоторые переменные неизвестны, но часть выражения можно упростить).

namespace Workshop2.Expressions.Expressions;

// ExpressionEvaluationResult представляет результат вычисления выражения.
// Это discriminated union с двумя вариантами: Full и Partial.
//
// Ключевая идея: не всегда возможно полностью вычислить выражение.
// Например, если в выражении "(x + 2) * 3" переменная x неизвестна,
// мы не можем получить конкретное число. Но если x известна, можем вычислить всё.
//
// Full (полное вычисление) — выражение вычислено до конкретного числа.
// Partial (частичное вычисление) — выражение упрощено, но не до конца.
//
// Преимущества такого подхода:
// 1. Явно разделяем два состояния результата
// 2. Компилятор заставляет обрабатывать оба случая
// 3. Можно строить выражения постепенно, вычисляя их частями по мере
//    получения новой информации о переменных
public abstract record ExpressionEvaluationResult
{
    // Приватный конструктор гарантирует, что можно создать только
    // определённые ниже варианты результата.
    private ExpressionEvaluationResult() { }

    // Абстрактное свойство для доступа к выражению результата.
    // В обоих случаях (Full и Partial) есть выражение, но типы разные.
    public abstract IExpression Expression { get; }

    // Вариант: полное вычисление выражения.
    // Результат — это конкретное числовое значение (IExpressionValue).
    // Параметры:
    //   Value — полностью вычисленное выражение с конкретным значением
    //
    // Пример: если вычисляем "(2 + 3)", получаем Full с ConstantExpression(5).
    public sealed record Full(IExpressionValue Value) : ExpressionEvaluationResult
    {
        // Возвращает выражение-значение как IExpression.
        // IExpressionValue наследуется от IExpression, поэтому приведение корректно.
        public override IExpression Expression => Value;

        // Переопределяет ToString для удобного вывода результата.
        // Возвращает строковое представление вычисленного значения.
        public override string ToString()
            => Value.Format();
    }

    // Вариант: частичное вычисление выражения.
    // Результат — это упрощённое, но не полностью вычисленное выражение.
    // Параметры:
    //   Value — частично вычисленное выражение
    //
    // Пример: если вычисляем "(x + 2)" и x неизвестна, получаем Partial
    // с тем же выражением или его упрощённой версией.
    // Другой пример: "(2 + 3) + x" может упроститься до "5 + x".
    public sealed record Partial(IExpression Value) : ExpressionEvaluationResult
    {
        // Возвращает частично вычисленное выражение.
        public override IExpression Expression => Value;

        // Переопределяет ToString для удобного вывода результата.
        // Возвращает строковое представление частично вычисленного выражения.
        public override string ToString()
            => Value.Format();
    }
}
